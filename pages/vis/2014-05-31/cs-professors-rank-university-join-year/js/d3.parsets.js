!function(){function a(a){return a.length?d3.keys(a[0]).sort():[]}function b(){d3.event.stopPropagation(),d3.event.preventDefault()}function c(a){return a.name}function d(a){return a[0].categories.reduce(function(a,b){return a+b.count},0)}function e(a,b){return function(c,d){var e=this.textContent=a(c,d),f=b(c,d);if(this.getComputedTextLength()<f)return e;this.textContent="\u2026"+e;for(var i,g=0,h=e.length+1;h>g;){var j=g+h>>1;(i=this.getSubStringLength(0,j))<f?g=j+1:h=j}return g>1?e.substr(0,g-2)+"\u2026":""}}function j(a,b,c,d){k(a);for(var e=b.length,f=c.length,g=0;e>g;g++){for(var h=b[g],i=d(h,g),j=a,l=0;f>l;l++){var m=c[l],n=h[m],o=j.children;j.count+=i,j=o.hasOwnProperty(n)?o[n]:o[n]={children:l===f-1?null:{},count:0,parent:j,dimension:m,name:n}}j.count+=i}return a}function k(a){if(a.count=0,a.children)for(var b in a.children)k(a.children[b])}function l(a){return a}function m(a){return"translate(0,"+a.y+")"}function n(a){for(var b=a.count,c=[];a.parent;)a.name&&c.unshift(a.name),a=a.parent;return c.join(" \u2192 ")+"<br>"+g(b)+" ("+f(b/a.count)+")"}function o(a){return a.name+"<br>"+g(a.count)+" ("+f(a.count/a.dimension.count)+")"}d3.parsets=function(){function y(a){a.each(function(a,h){function N(){var a=d3.interpolateNumber(w,v);return function(b){w=a(b),L.attr("d",G)}}function O(){var e=k.selectAll("g.dimension"),g={};e.each(function(a){g[a.name]=a}),y.forEach(function(a){g.hasOwnProperty(a)||(g[a]={name:a,categories:[]}),z.push(g[a])}),z.sort(J),k.select(".ribbon").selectAll("path").each(function(a){for(var b=a.path.split("\0"),c=A,d=b.length-1,e=0;d>e;e++){var f=b[e];c=c.children.hasOwnProperty(f)?c.children[f]:c.children[f]={children:{},count:0}}c.children[a.name]=a}),A=j(A,a,z.map(c),r),g=z.map(function(a){var b={};return a.categories.forEach(function(a){b[a.name]=a}),b}),function p(a,b){if(a.children){var c=z[b],d=g[b];for(var e in a.children)d.hasOwnProperty(e)||c.categories.push(d[e]={name:e}),p(a.children[e],b+1)}}(A,0),n.domain([]).range(d3.range(z[0].categories.length)),I=F(A,z,n),K=d(z),z.forEach(function(a){a.count=K}),e=e.data(z,c);var h=e.enter().append("g").attr("class","dimension").attr("transform",function(a){return"translate(0,"+a.y+")"}).on("mousedown.parsets",b);e.each(function(a){a.y0=a.y,a.categories.forEach(function(a){a.x0=a.x})}),h.append("rect").attr("width",t).attr("y",-45).attr("height",45);var i=h.append("text").attr("class","dimension").attr("transform","translate(0,-25)");i.append("tspan").attr("class","name").text(B),i.append("tspan").attr("class","sort alpha").attr("dx","2em").text("alpha \xbb").on("mousedown.parsets",b),i.append("tspan").attr("class","sort size").attr("dx","2em").text("size \xbb").on("mousedown.parsets",b),e.call(d3.behavior.drag().origin(l).on("dragstart",function(a){o=!0,a.y0=a.y}).on("drag",function(b){b.y0=b.y=d3.event.y;for(var g=1;g<z.length;g++)if(u*z[g].y<u*z[g-1].y){z.sort(J),y=z.map(c),n.domain([]).range(d3.range(z[0].categories.length)),I=F(A=j({children:{},count:0},a,y,r),z,n),K=d(z),k.selectAll(".ribbon, .ribbon-mouse").selectAll("path").remove(),Q(),V(e),e.transition().duration(x).attr("transform",m).tween("ribbon",S),f.sortDimensions();break}d3.select(this).attr("transform","translate(0,"+b.y+")").transition(),L.filter(function(a){return a.source.dimension===b||a.target.dimension===b}).attr("d",G)}).on("dragend",function(a){o=!1,U();var b=45,c=(u-b-2)/(z.length-1);z.forEach(function(a,d){a.y=b+d*c}),E(d3.select(this)).attr("transform","translate(0,"+a.y+")").tween("ribbon",S)})),e.select("text").select("tspan.sort.alpha").on("click.parsets",P("alpha",function(a,b){return a.name<b.name?1:-1},e)),e.select("text").select("tspan.sort.size").on("click.parsets",P("size",function(a,b){return a.count-b.count},e)),e.transition().duration(x).attr("transform",function(a){return"translate(0,"+a.y+")"}).tween("ribbon",S),e.exit().remove(),V(e),Q()}function P(a,b,c){return function(d){var e=this.__direction=-(this.__direction||1);d3.select(this).text(e>0?a+" \xbb":"\xab "+a),d.categories.sort(function(){return e*b.apply(this,arguments)}),I=F(A,z,n),V(c),Q(),f.sortCategories()}}function Q(){L=k.select(".ribbon").selectAll("path").data(I,function(a){return a.path}),L.enter().append("path").each(function(a){a.source.x0=a.source.x,a.target.x0=a.target.x}).attr("class",function(a){return"category-"+a.major}).attr("d",G),L.sort(function(a,b){return b.count-a.count}),L.exit().remove();var a=k.select(".ribbon-mouse").selectAll("path").data(I,function(a){return a.path});a.enter().append("path").on("mousemove.parsets",function(a){L.classed("active",!1),o||(T(a=a.node,!0),C(p.call(this,a)),d3.event.stopPropagation())}),a.sort(function(a,b){return b.count-a.count}).attr("d",H),a.exit().remove()}function R(a){var b=[a],c=L.filter(function(c){var d,e;return c.source.node===a&&b.push(d=c.source),c.target.node===a&&b.push(e=c.target),d||e}),d=b.map(function(a){return d3.interpolateNumber(a.x0,a.x)}),e=b.length;return function(a){for(var f=0;e>f;f++)b[f].x0=d[f](a);c.attr("d",G)}}function S(a){var b=L.filter(function(b){return b.source.dimension.name==a.name||b.target.dimension.name==a.name}),c=d3.interpolateNumber(a.y0,a.y);return function(d){a.y0=c(d),b.attr("d",G)}}function T(a,b){if(!o){var c=[];if(function d(a){c.push(a);for(var b in a.children)d(a.children[b])}(a),c.shift(),b)for(;a;)c.push(a),a=a.parent;L.filter(function(a){var b=c.indexOf(a.node)>=0;return b&&this.parentNode.appendChild(this),b}).classed("active",!0)}}function U(){o||(L.classed("active",!1),D())}function V(a){var c=a.selectAll("g.category").data(function(a){return a.categories},function(a){return a.name}),d=c.enter().append("g").attr("class","category").attr("transform",function(a){return"translate("+a.x+")"});c.exit().remove(),c.on("mousemove.parsets",function(a){L.classed("active",!1),o||(a.nodes.forEach(function(a){T(a)}),C(q.call(this,a)),d3.event.stopPropagation())}).on("mouseout.parsets",U).on("mousedown.parsets",b).call(d3.behavior.drag().origin(l).on("dragstart",function(a){o=!0,a.x0=a.x}).on("drag",function(b){b.x=d3.event.x;for(var c=b.dimension.categories,d=0,e=c[0];++d<c.length;)if(e.x+e.dx/2>(e=c[d]).x+e.dx/2){c.sort(function(a,b){return a.x+a.dx/2-b.x-b.dx/2}),I=F(A,z,n),Q(),V(a),T(b.node),f.sortCategories();break}var g=0,h=s/(c.length-1);c.forEach(function(a){b===a&&(a.x0=d3.event.x),a.x=g,g+=a.count/K*(t-s)+h}),d3.select(this).attr("transform",function(a){return"translate("+a.x0+")"}).transition(),L.filter(function(a){return a.source.node===b||a.target.node===b}).attr("d",G)}).on("dragend",function(a){o=!1,U(),Q(),E(d3.select(this)).attr("transform","translate("+a.x+")").tween("ribbon",R)})),c.transition().duration(x).attr("transform",function(a){return"translate("+a.x+")"}).tween("ribbon",R),d.append("rect").attr("width",function(a){return a.dx}).attr("y",-20).attr("height",20),d.append("line").style("stroke-width",2),d.append("text").attr("dy","-.3em"),c.select("rect").attr("width",function(a){return a.dx}).attr("class",function(a){return"category-"+(a.dimension===z[0]?n(a.name):"background")}),c.select("line").attr("x2",function(a){return a.dx}),c.select("text").text(e(function(a){return a.name},function(a){return a.dx}))}var I,K,L,k=d3.select(this),n=d3.scale.ordinal(),o=!1,y=g.call(this,a,h),z=[],A={children:{},count:0};if(d3.select(window).on("mousemove.parsets."+ ++i,U),null==w&&(w=v),k.selectAll(".ribbon, .ribbon-mouse").data(["ribbon","ribbon-mouse"],String).enter().append("g").attr("class",String),O(),v!=w){var M=d3.transition(k);M.tween?M.tween("ribbon",N):N()(1)}})}function B(a,b){return k.call(this,a.name,b)}function C(a){var b=d3.mouse(z.node());A.style("display",null).style("left",b[0]+30+"px").style("top",b[1]-20+"px").html(a)}function D(){A.style("display","none")}function E(a){return x?a.transition().duration(x).ease(h):a}function F(a,b,c){function j(a,c,e,f){var g=c.node,i=b[e];i.categories.forEach(function(k){var l=k.name;if(g.children.hasOwnProperty(l)){var m=g.children[l];m.path=c.path+"\0"+l;var n=m.target||{node:k,dimension:i};n.x=k.in.dx,n.dx=m.count/h*(t-s),k.in.dx+=n.dx;var o=m.source||{node:a,dimension:b[e-1]};o.x=a.out.dx,o.dx=n.dx,a.out.dx+=o.dx,m.node=m,m.source=o,m.target=n,m.major=f,d.push(m),e+1<b.length&&j(k,m,e+1,f)}})}var d=[],e=b.length,f=45,g=(u-f-2)/(e-1);b.forEach(function(a,b){a.categories.forEach(function(b){b.dimension=a,b.count=0,b.nodes=[]}),a.y=f+b*g});var h=function k(a,c){if(!a.children)return a.count;var d=b[c],e=0;return d.categories.forEach(function(b){var d=a.children[b.name];if(d){b.nodes.push(d);var f=k(d,c+1);b.count+=f,e+=f}}),e}(a,0);b.forEach(function(a){a.categories=a.categories.filter(function(a){return a.count});var b=0,c=s/(a.categories.length-1);a.categories.forEach(function(a){a.x=b,a.dx=a.count/h*(t-s),a.in={dx:0},a.out={dx:0},b+=a.dx+c})});var i=b[0];return i.categories.forEach(function(b){var d=b.name;a.children.hasOwnProperty(d)&&j(b,{node:a.children[d],path:d},1,c(d))}),d}function G(a){var b=a.source,c=a.target;return I(b.node.x0+b.x0,b.dimension.y0,b.dx,c.node.x0+c.x0,c.dimension.y0,c.dx,w)}function H(a){var b=a.source,c=a.target;return I(b.node.x+b.x,b.dimension.y,b.dx,c.node.x+c.x,c.dimension.y,c.dx,v)}function I(a,b,c,d,e,f,g){var h,i;return(1===g?["M",[a,b],"L",[d,e],"h",f,"L",[a+c,b],"Z"]:["M",[a,b],"C",[a,h=g*b+(1-g)*e]," ",[d,i=g*e+(1-g)*b]," ",[d,e],"h",f,"C",[d+f,i]," ",[a+c,h]," ",[a+c,b],"Z"]).join("")}function J(a,b){return a=u*a.y,b=u*b.y,b>a?-1:a>b?1:a>=b?0:a>=a?-1:b>=b?1:0/0}var r,t,u,w,f=d3.dispatch("sortDimensions","sortCategories"),g=a,k=String,p=n,q=o,s=20,v=1,x=500;y.dimensionFormat=function(a){return arguments.length?(k=a,y):k},y.dimensions=function(a){return arguments.length?(g=d3.functor(a),y):g},y.value=function(a){return arguments.length?(r=d3.functor(a),y):r},y.width=function(a){return arguments.length?(t=+a,y):t},y.height=function(a){return arguments.length?(u=+a,y):u},y.spacing=function(a){return arguments.length?(s=+a,y):s},y.tension=function(a){return arguments.length?(v=+a,y):v},y.duration=function(a){return arguments.length?(x=+a,y):x},y.tooltip=function(a){return arguments.length?(A=null==a?n:a,y):A},y.categoryTooltip=function(a){return arguments.length?(q=null==a?o:a,y):q};var z=d3.select("body"),A=z.append("div").style("display","none").attr("class","parsets tooltip");return d3.rebind(y,f,"on").value(1).width(960).height(600)},d3.parsets.tree=j;var f=d3.format("%"),g=d3.format(",f"),h="elastic",i=0}();
